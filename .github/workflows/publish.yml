name: Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish_target:
        description: 'Publish target'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - github
          - maven-central

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false

jobs:
  publish:
    name: Publish to ${{ github.event.inputs.publish_target || 'Maven Central' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Build all modules
      run: ./gradlew build --no-daemon

    - name: Run tests
      run: ./gradlew test --no-daemon

    - name: Publish to Local Maven
      if: github.event.inputs.publish_target == 'local' || github.event_name == 'workflow_dispatch'
      run: ./gradlew publishToMavenLocal --no-daemon

    - name: Publish to GitHub Packages
      if: github.event.inputs.publish_target == 'github' || github.event_name == 'release'
      run: ./gradlew publish --no-daemon
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}

    # TODO: Enable when Maven Central credentials are configured
    # - name: Publish to Maven Central
    #   if: github.event.inputs.publish_target == 'maven-central' || github.event_name == 'release'
    #   run: ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository --no-daemon
    #   env:
    #     ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
    #     ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
    #     ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
    #     ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}

    - name: Create GitHub Release Assets
      if: github.event_name == 'release'
      run: |
        mkdir -p release-artifacts
        find . -name "*.aar" -o -name "*.jar" | grep -v "unspecified" | xargs -I {} cp {} release-artifacts/

    - name: Upload Release Assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: release-artifacts/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
