name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        git merge-base --is-ancestor HEAD origin/${{ github.base_ref }} || exit 0
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
          echo "::error::PR has merge conflicts"
          exit 1
        fi

    - name: Build all modules
      run: ./gradlew build --no-daemon

    - name: Run tests with coverage
      run: ./gradlew test --no-daemon

    - name: ktlint check
      run: ./gradlew ktlintCheck --no-daemon

    - name: Check for TODO/FIXME in modified files
      run: |
        git diff origin/${{ github.base_ref }}...HEAD --name-only | \
        grep -E '\.(kt|kts)$' | \
        xargs grep -n 'TODO\|FIXME' || true

    - name: Comment PR with test results
      if: always()
      uses: mikepenz/action-junit-report@v4
      with:
        report_paths: '**/build/test-results/**/TEST-*.xml'
        check_name: Test Results

  size-check:
    name: APK/AAR Size Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build release artifacts
      run: ./gradlew assembleRelease --no-daemon

    - name: Calculate artifact sizes
      run: |
        echo "## Build Artifact Sizes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
        find . -name "*.aar" -o -name "*.apk" | while read file; do
          size=$(du -h "$file" | cut -f1)
          name=$(basename "$file")
          echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
        done
